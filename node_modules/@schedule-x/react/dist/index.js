import { jsx, Fragment, jsxs } from 'react/jsx-runtime';
import { useState, useEffect, Fragment as Fragment$1, createElement } from 'react';
import { createPortal } from 'react-dom';
import { createCalendar } from '@schedule-x/calendar';

const createCustomComponentFn = (setCustomComponent, customComponent) => (wrapperElement, props) => {
    setCustomComponent({
        Component: createElement(customComponent, props),
        wrapperElement,
    });
};
function ScheduleXCalendar({ calendarApp, customComponents }) {
    const [randomId, setRandomId] = useState('');
    const [customComponentsMeta, setCustomComponentsMeta] = useState([]);
    const setComponent = (component) => {
        setCustomComponentsMeta((prev) => {
            const newComponents = [...prev];
            const ccid = component.wrapperElement.dataset.ccid;
            const existingComponent = newComponents.find((c) => c.wrapperElement.dataset.ccid === ccid);
            if (existingComponent) {
                newComponents.splice(newComponents.indexOf(existingComponent), 1);
            }
            return [...newComponents, component];
        });
    };
    useEffect(() => {
        setRandomId('sx' + Math.random().toString(36).substring(2, 11));
    }, []);
    useEffect(() => {
        if (!calendarApp)
            return; // in SSR, calendarApp will be undefined
        for (const [componentName, Component] of Object.entries(customComponents || {})) {
            calendarApp._setCustomComponentFn(componentName, createCustomComponentFn(setComponent, Component));
        }
        const calendarElement = document.getElementById(randomId);
        if (!calendarElement)
            return;
        calendarApp.render(calendarElement);
    }, [calendarApp, customComponents, randomId]);
    return (jsx(Fragment, { children: jsxs(Fragment$1, { children: [jsx("div", { className: "sx-react-calendar-wrapper", id: randomId }), customComponentsMeta.map(({ Component, wrapperElement }) => {
                    return createPortal(Component, wrapperElement);
                })] }) }));
}

function useCalendarApp(config, plugins) {
    const [calendarApp] = useState(() => createCalendar(config, plugins));
    return calendarApp;
}
function useNextCalendarApp(config, plugins) {
    const [calendarApp, setCalendarApp] = useState();
    useEffect(() => {
        if (typeof window !== 'undefined') {
            setCalendarApp(createCalendar(config, plugins));
        }
    }, []);
    return calendarApp;
}

export { ScheduleXCalendar, useCalendarApp, useNextCalendarApp };
